{% extends "admin/base.html" %}
{% block branding %}
<style>
    /* 1. モーダル等の基本設定（維持） */
    .modal-content { position: fixed !important; top: 45% !important; left: 50% !important; transform: translate(-50%, -50%) !important; height: 70vh !important; max-width: 85vw !important; border: 3px solid #fff !important; z-index: 20001 !important; display: block !important; }
    #modal-cart-btn { position: fixed !important; top: calc(45% + (70vh / 2)) !important; left: 50% !important; transform: translate(-50%, 0) !important; width: calc(85vw + 6px) !important; background: #28a745 !important; color: white !important; padding: 15px 0 !important; font-size: 18px !important; font-weight: 900 !important; border: 3px solid #fff !important; z-index: 20015 !important; }

    /* 2. スマホ用：ご指定のレイアウトに強制固定 */
    @media (max-width: 768px) {
        /* テーブル構造を解除して自由な配置（Flex）にする */
        .results table, .results tbody { display: block !important; width: 100% !important; }
        .results thead { display: none !important; } /* ヘッダーは不要 */

        .results tr {
            display: grid !important;
            grid-template-columns: 40px 1fr 100px !important; /* 左:CB, 中:画像, 右:タイマー */
            grid-template-areas: 
                "price price price"
                "check img timer"
                "name name name" !important;
            border-bottom: 2px solid #444 !important;
            padding: 10px 0 !important;
            align-items: center !important;
            background: #1a1a1a !important;
        }

        /* 画像名（金額）を画像の上に設置 */
        .mobile-price-top { grid-area: price; color: #ffcc00; font-weight: bold; text-align: center; font-size: 16px; margin-bottom: 5px; }
        
        /* 画像の左にチェックボックス */
        .action-checkbox, .action-checkbox-column { grid-area: check; display: flex !important; justify-content: center !important; }

        /* 画像エリア */
        .field-image, .field-product_image { grid-area: img; display: flex !important; justify-content: center !important; }
        .field-image img, .field-product_image img { max-width: 150px !important; height: auto !important; border: 1px solid #fff; display: block !important; }

        /* 画像の右にタイマー */
        td[class*="timer"], td[class*="time"], .field-timer_display { 
            grid-area: timer; display: flex !important; color: #00ffcc !important; font-weight: bold; font-size: 13px; justify-content: center; text-align: center;
        }

        /* 画像の下に商品名（2行構成） */
        .mobile-name-bottom { 
            grid-area: name; color: #fff; text-align: center; padding: 10px; line-height: 1.4; font-size: 15px; 
            border-top: 1px path #333; margin-top: 5px;
        }

        /* 不要な元のセルを隠す */
        .results td:not(.action-checkbox):not(.field-image):not(.field-product_image):not([class*="timer"]):not([class*="time"]):not(.field-timer_display) {
            display: none !important;
        }
    }
</style>

<script>
    function rebuildLayout() {
        const rows = document.querySelectorAll('#result_list tbody tr');
        rows.forEach(row => {
            if (row.querySelector('.mobile-name-bottom')) return;

            // 1. 金額（画像の上）を抽出
            const priceCell = row.querySelector('.field-price, .field-product_price');
            const priceText = priceCell ? priceCell.innerText.trim() : "";
            const priceDiv = document.createElement('div');
            priceDiv.className = 'mobile-price-top';
            priceDiv.innerText = priceText;
            row.prepend(priceDiv);

            // 2. 商品名（画像の下：2行）を抽出・整形
            const nameCell = row.querySelector('.field-name, .field-product_name, td:nth-child(2)');
            if (nameCell) {
                let cleanText = nameCell.innerText.split("同人")[0].trim();
                let parts = cleanText.split(/[\s　]+/); // 空白で分割
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'mobile-name-bottom';
                // 1行目: キャラ名, 2行目: 原作名
                nameDiv.innerHTML = `<strong>${parts[0] || ""}</strong><br><span style="color:#bbb; font-size:13px;">${parts.slice(1).join(" ") || ""}</span>`;
                row.appendChild(nameDiv);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", rebuildLayout);
    window.addEventListener("load", rebuildLayout);
    setInterval(rebuildLayout, 1000); // 念のための監視実行
</script>

<h1 id="site-name"><a href="{% url 'admin:index' %}">kawaii女の子図鑑</a></h1>
{% endblock %}
